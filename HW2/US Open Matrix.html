<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>DV HW 2</title>

        <!-- Scripts -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>

        <!-- For the Matrix -->
        <style type="text/css">
            @import url(css/style.css);
            .background {
                fill: #eee;
            }
            line {
                stroke: #fff;
            }
            text.active {
                fill: #d00;
            }
        </style>
        
        <!-- For the Modal Dialog Box -->
        <style type="text/css">
            /* The Modal (background) */
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1; /* Sit on top */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgb(0,0,0); /* Fallback color */
                background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            }

            /* Modal Content/Box */
            .modal-content {
                background-color: #fefefe;
                overflow: scroll;
                margin: 5% auto; /* 15% from the top and centered */
                padding: 20px;
                border: 1px solid #888;
                height: 80%;
                width: 80%; /* Could be more or less, depending on screen size */
            }

            /* The Close Button */
            .close {
                color: #666;
                float: right;
                font-family: monospace;
                font-size: 20px;
            }

            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <!-- The Modal Dialog Box -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="close">x</span>
                <h3><font name="winner"></font> has played <font name="loser"></font> <font name="total_times" style="font-size:1.3em;color:gray"></font> time(s) in the US Open so far and has won <font name="winner_times" style="font-size:1.3em;color:#339966"></font> of those.</h3>
                <font style="font-size:1.7em;font-weight:bold">Encounters favoring <font name="winner" style="font-size:1.3em;color:#339966"></font> : </font><font id="encounters"></font>
                <br><br>
                <u><h3>Stats aggregate for these matches</h3></u>

            </div>
        </div>


        <!-- The Dropdown list for choosing the sorting -->
        Sort: 
        <select id="order">
            <option value="count">by Frequency of Occurance</option>
            <option value="name">by Name</option>
        </select>
        <br>


        <script type="text/javascript">
            var names = [], nodes = [], links = [], matrixData = {};
            d3.csv("data/data.csv", function(data) {
                data.map(function(d) {
                    if ( names.indexOf(d.player1) === -1 ) {
                        names.push(d.player1);
                    }
                    if ( names.indexOf(d.player2) === -1 ) {
                        names.push(d.player2);
                    }
                });
                names.sort();

                for (var i = 0; i < names.length; i++) {
                    var node = {};
                    node["name"] = names[i];
                    node["group"] = "20";
                    nodes.push(node);
                }

                data.map(function(d) {
                    var player1 = d.player1, player2 = d.player2;
                    var player1Index = names.indexOf(player1);
                    var player2Index = names.indexOf(player2);
                    var link = {};
                    link["source"] = player1Index;
                    link["target"] = player2Index;
                    link["value"] = 1;
                    links.push(link);
                });

                matrixData["nodes"] = nodes;
                matrixData["links"] = links;

                /* Set up the Modal Dialog Box */
                var modal = document.getElementById('myModal');
                var span = document.getElementsByClassName("close")[0];
                span.onclick = function() {
                    modal.style.display = "none";
                }
                window.onclick = function(event) {
                    if (event.target == modal) {
                        modal.style.display = "none";
                    }
                }

                var margin = {top: 140, right: 500, bottom: 200, left: 140},
                    width = 3600,
                    height = 3600;

                var x = d3.scale.ordinal().rangeBands([0, width]),
                    z = d3.scale.linear().domain([0, 4]).clamp(true),
                    c = d3.scale.category10().domain(d3.range(10));

                var svg = d3.select("body").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .style("margin-left", -margin.left + "px")
                  .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var matrix = [], n = nodes.length;
                
                nodes.forEach(function(node, i) {
                    node.index = i;
                    node.count = 0;
                    matrix[i] = d3.range(n).map(function(j) { return {x: j, y: i, z: 0}; });
                });

                links.forEach(function(link) {
                    matrix[link.source][link.target].z += link.value;
                    nodes[link.source].count += link.value;
                    nodes[link.target].count += link.value;
                });
                
                // Precompute the orders.
                var orders = {
                    name: d3.range(n).sort(function(a, b) { return d3.ascending(nodes[a].name, nodes[b].name); }),
                    count: d3.range(n).sort(function(a, b) { return nodes[b].count - nodes[a].count; }),
                    group: d3.range(n).sort(function(a, b) { return nodes[b].group - nodes[a].group; })
                };

                // The default sort order.
                x.domain(orders.count);

                svg.append("rect")
                      .attr("class", "background")
                      .attr("width", width)
                      .attr("height", height);

                var row = svg.selectAll(".row")
                      .data(matrix)
                    .enter().append("g")
                      .attr("class", "row")
                      .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
                      .each(row);

                row.append("line")
                      .attr("x2", width);

                row.append("text")
                      .attr("x", -6)
                      .attr("y", x.rangeBand() / 2)
                      .attr("dy", ".32em")
                      .attr("text-anchor", "end")
                      .text(function(d, i) { return nodes[i].name; });

                var column = svg.selectAll(".column")
                      .data(matrix)
                    .enter().append("g")
                      .attr("class", "column")
                      .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });

                column.append("line")
                    .attr("x1", -width);

                column.append("text")
                    .attr("x", 6)
                    .attr("y", x.rangeBand() / 2)
                    .attr("dy", ".32em")
                    .attr("text-anchor", "start")
                    .text(function(d, i) { return nodes[i].name; });

                var tooltip = d3.select("body")
                        .append("div")
                        .style("background", "#fff")
                        .style("border", "2px black")
                        .style("padding", "20px")
                        .style("position", "absolute")
                        .style("box-shadow", "0px 3px 2px #ccc")
                        .style("z-index", "10")
                        .style("visibility", "hidden")
                        .text("a simple tooltip");

                function row(row) {
                    var cell = d3.select(this).selectAll(".cell")
                        .data(row.filter(function(d) { return d.z; }))
                      .enter().append("rect")
                        .attr("class", "cell")
                        .attr("x", function(d) { return x(d.x); })
                        .attr("width", x.rangeBand())
                        .attr("height", x.rangeBand())
                        .style("fill-opacity", function(d) { return z(d.z); })
                        .style("fill", function(d) { return nodes[d.x].group == nodes[d.y].group ? c(nodes[d.x].group) : null; })
                        .on("mouseover", mouseover)
                        .on("mousemove", mousemove)
                        .on("mouseout", mouseout)
                        .on("click", click);
                }

                function mouseover(p) {
                    tooltip.style("visibility", "visible");
                    tooltip.text(names[p.y] + " vs " + names[p.x] + " - Total Meetings: " + (matrix[p.x][p.y].z + matrix[p.y][p.x].z) + ". "  + names[p.y] + " has won " + p.z + " of them.");
                    d3.selectAll(".row text").classed("active", function(d, i) { return i == p.y; });
                    d3.selectAll(".column text").classed("active", function(d, i) { return i == p.x; });
                }

                function mousemove() {
                    tooltip.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");
                }

                function mouseout() {
                    tooltip.style("visibility", "hidden");
                    d3.selectAll("text").classed("active", false);
                }

                function click(p) {
                    tooltip.style("visibility", "hidden");
                    d3.selectAll("text").classed("active", false);
                    modal.style.display = "block";
                    var winner = document.getElementsByName("winner");
                    var loser = document.getElementsByName("loser");
                    var winner_times = document.getElementsByName("winner_times");
                    var total_times = document.getElementsByName("total_times");
                    for (var i = 0; i < winner.length; i++) {
                        winner[i].innerHTML = names[p.y];
                    }
                    loser[0].innerHTML = names[p.x];
                    winner_times[0].innerHTML = matrix[p.y][p.x].z;
                    total_times[0].innerHTML = matrix[p.y][p.x].z + matrix[p.x][p.y].z;

                    d3.csv("data/data.csv", function(data) {
                        data = data.filter(function(d) { return ( d.player1 == names[p.y] && d.player2 == names[p.x] ); });
                        var encounters = document.getElementById("encounters");
                        var years = [];
                        if(data.length > 1) {
                            data.map(function(d) {
                                years.push("<a href=\"#yo\" style=\"color:black;font-size:1.5em\">" + d.year + "</a>");
                            });
                        } else { 
                            years.push("<font style=\"color:black;font-size:1.5em\">" + data[0].year + "</font>");
                        }
                        encounters.innerHTML = years.sort();
                    });
                }

                d3.select("#order").on("change", function() {
                    order(this.value);
                });

                function order(value) {
                    x.domain(orders[value]);
                    var t = svg.transition().duration(1000);

                    t.selectAll(".row")
                        .delay(function(d, i) { return x(i) * 4; })
                        .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
                        .selectAll(".cell")
                        .delay(function(d) { return x(d.x) * 4; })
                        .attr("x", function(d) { return x(d.x); });

                    t.selectAll(".column")
                        .delay(function(d, i) { return x(i) * 4; })
                        .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
                }
            });
        </script>
    </body>
</html>